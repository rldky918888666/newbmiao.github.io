<!-- build time:Tue Jan 08 2019 08:19:00 GMT+0800 (中国标准时间) --><!DOCTYPE html><html><head><meta charset="utf-8"><title>go源码分析之内存分配 | 菜鸟Miao</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="google-site-verification" content="q90Bd4BGjQuSBoXdzK6CUCB8mMUeCEO6MKbaCQS773E"><meta name="keywords" itemprop="keywords" content="源码分析,内存分配"><meta name="description" content="go源码分析之内存分配"><meta name="keywords" content="源码分析,内存分配"><meta property="og:type" content="article"><meta property="og:title" content="go源码分析之内存分配"><meta property="og:url" content="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html"><meta property="og:site_name" content="菜鸟Miao"><meta property="og:description" content="go源码分析之内存分配"><meta property="og:image" content="http://media.newbmiao.com/blog/go_areana.png"><meta property="og:image" content="http://media.newbmiao.com/blog/memory.png"><meta property="og:image" content="http://media.newbmiao.com/blog/malloc.png"><meta property="og:updated_time" content="2018-10-05T06:49:08.835Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="go源码分析之内存分配"><meta name="twitter:description" content="go源码分析之内存分配"><meta name="twitter:image" content="http://media.newbmiao.com/blog/go_areana.png"><link rel="alternative" href="/atom.xml" title="菜鸟Miao" type="application/atom+xml"><link rel="icon" href="http://media.newbmiao.com/blog/asset/favicon.ico"><link rel="stylesheet" href="//media.newbmiao.com/blog/asset/css/style.css" type="text/css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]--></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">菜鸟Miao</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">start from a newb...</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a> <a class="main-nav-link" href="/add-ons">小玩意</a> <a class="main-nav-link" href="/invest">投资</a> <a class="main-nav-link" href="/book">书单</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><div id="search-form"><input type="text" class="st-default-search-input search-form-input" style="outline:0;width:110px"></div></div></div></div></header><div class="outer"><section id="main"><article id="post-go-source-analysis-of-memory-alloc" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2018/08/20/go-source-analysis-of-memory-alloc.html" class="article-date"><time datetime="2018-08-20T07:51:22.000Z" itemprop="datePublished">2018-08-20</time></a><div class="article-category"><a class="article-category-link" href="/categories/go/">go</a>►<a class="article-category-link" href="/categories/go/notes/">notes</a></div></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">go源码分析之内存分配</h1></header><div class="article-entry" itemprop="articleBody"><div id="toc" class="toc-article"><h3>文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#go源码分析之内存池"><span class="toc-number">1.</span> <span class="toc-text">go源码分析之内存池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#概述"><span class="toc-number">1.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存划分"><span class="toc-number">1.2.</span> <span class="toc-text">内存划分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存结构"><span class="toc-number">1.3.</span> <span class="toc-text">内存结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mspan"><span class="toc-number">1.3.1.</span> <span class="toc-text">mspan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mcache"><span class="toc-number">1.3.2.</span> <span class="toc-text">mcache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mcentral"><span class="toc-number">1.3.3.</span> <span class="toc-text">mcentral</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mheap"><span class="toc-number">1.3.4.</span> <span class="toc-text">mheap</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#内存分配流程"><span class="toc-number">1.4.</span> <span class="toc-text">内存分配流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#对象分配"><span class="toc-number">1.4.1.</span> <span class="toc-text">对象分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#对象释放"><span class="toc-number">1.4.2.</span> <span class="toc-text">对象释放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.5.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div><h1 id="go源码分析之内存池"><a href="#go源码分析之内存池" class="headerlink" title="go源码分析之内存池"></a>go源码分析之内存池</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>go自带内存管理，主要是内存池和垃圾回收两部分。因为其对内存的管理在性能和空间利用率上的高效，go内存大多数情况不需要用户自己去管理内存，让程序员减少了很多在内存管理的心智成本。虽然如此，本文还是借着源码，分析下go的内存管理中内存池分配时如何实现的，希望对大家了解有所帮助。如有问题，欢迎探讨指正。<br>(源码基于go 1.10.3)</p><p>首先，内存分配模型基于<a href="http://goog-perftools.sourceforge.net/doc/tcmalloc.html" target="_blank" rel="external">tcmalloc</a>，Tcmalloc是Google gperftools里的组件之一。全名是 thread cache malloc（线程缓存分配器）,其内存管理分为线程内存和中央堆两部分。在并行程序下分配小对象（&lt;=32k）的效率很高。<br>Tcmalloc核心思想是把内存分成多级来降低锁的粒度。每个线程都会有一个cache，用于无锁分配小对象，当内存不足分配小对象，就去central申请，在不足就去heap申请，heap最终是向操作系统申请。<br>这样的分配模型，维护一个用户态的内存池，不仅提高了内存在频繁分配、释放时的效率，而且有效地减少内存碎片。</p><p>下面我们依次看下go中内存如何划分，主要的一些内存结构，最后在结合源码看一下主要的内存分配流程。</p><a id="more"></a><h2 id="内存划分"><a href="#内存划分" class="headerlink" title="内存划分"></a>内存划分</h2><p>初始化时，go申请一段连续地址，并切分分为三块:spans bitmap areana<br>（详见runtime/malloc.go）</p><p>在64位系统中，他们对应关系是：<br>go中一个指针大小是8byte<br>arena区域就是heap，是供分配维护的内存池，对应区域大小是512G；<br>bitmap区域是标识arena中那些地址保存了对象，及对象中是否包含了指针，其中1个byte（8bit）对应arena中4个指针大小的内存（即：2bit对应1个指针大小），对应大小16G；<br>span是页管理单元，是内存分配的基本单位，其中一个指针对应arena中1个虚拟地址页大小（8kb），对应大小512M</p><p>也就是如下图的大小分配：</p><p><img src="http://media.newbmiao.com/blog/go_areana.png" alt="内存大小对应"></p><h2 id="内存结构"><a href="#内存结构" class="headerlink" title="内存结构"></a>内存结构</h2><p>如下图是整体的内存结构：<br><img src="http://media.newbmiao.com/blog/memory.png" alt="内存结构"></p><h3 id="mspan"><a href="#mspan" class="headerlink" title="mspan"></a>mspan</h3><p>管理预分配页个数为sizeClass的连续地址内存，是基本的内存分配管理单位；<br>栈内存池（stack pool）就是使用mspan构成的链表来分配内存，具体见runtime/stack.go</p><p>(栈内存池是go协程启动是用来存储函数内变量，执行函数调用等；维护一个栈内存池，减少协程频繁启动退出的内存分配开销)<br></p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> mspan struct &#123;</div><div class="line">	next *mspan     // next span <span class="keyword">in</span> list, <span class="keyword">or</span> <span class="keyword">nil</span> <span class="keyword">if</span> none</div><div class="line">	prev *mspan     // previous span <span class="keyword">in</span> list, <span class="keyword">or</span> <span class="keyword">nil</span> <span class="keyword">if</span> none</div><div class="line">	list *mSpanList // <span class="type">For</span> debugging. <span class="type">TODO</span>: <span class="type">Remove</span>.</div><div class="line"></div><div class="line">	startAddr uintptr // address <span class="keyword">of</span> first byte <span class="keyword">of</span> span aka s.base()</div><div class="line">	npages    uintptr // number <span class="keyword">of</span> pages <span class="keyword">in</span> span</div><div class="line"></div><div class="line">	manualFreeList gclinkptr // list <span class="keyword">of</span> free objects <span class="keyword">in</span> _MSpanManual spans</div><div class="line"></div><div class="line">	freeindex uintptr </div><div class="line">	nelems uintptr // number <span class="keyword">of</span> <span class="keyword">object</span> <span class="keyword">in</span> the span.</div><div class="line">	allocCache <span class="built_in">uint64</span></div><div class="line">	allocBits  *gcBits</div><div class="line">	gcmarkBits *gcBits</div><div class="line"></div><div class="line">	sweepgen    <span class="built_in">uint32</span></div><div class="line">	divMul      <span class="built_in">uint16</span>     // <span class="keyword">for</span> divide by elemsize - divMagic.mul</div><div class="line">	baseMask    <span class="built_in">uint16</span>     // <span class="keyword">if</span> non-<span class="number">0</span>, elemsize <span class="keyword">is</span> a power <span class="keyword">of</span> <span class="number">2</span>, &amp; this will get <span class="keyword">object</span> allocation base</div><div class="line">	allocCount  <span class="built_in">uint16</span>     // number <span class="keyword">of</span> allocated objects</div><div class="line">	spanclass   spanClass  // size class <span class="keyword">and</span> noscan (<span class="built_in">uint8</span>)</div><div class="line">	incache     <span class="built_in">bool</span>       // being used by an mcache</div><div class="line">	state       mSpanState // mspaninuse etc</div><div class="line">	needzero    <span class="built_in">uint8</span>      // needs to be zeroed before allocation</div><div class="line">	divShift    <span class="built_in">uint8</span>      // <span class="keyword">for</span> divide by elemsize - divMagic.shift</div><div class="line">	divShift2   <span class="built_in">uint8</span>      // <span class="keyword">for</span> divide by elemsize - divMagic.shift2</div><div class="line">	elemsize    uintptr    // computed <span class="keyword">from</span> sizeclass <span class="keyword">or</span> <span class="keyword">from</span> npages</div><div class="line">	unusedsince <span class="built_in">int64</span>      // first time spotted by gc <span class="keyword">in</span> mspanfree state</div><div class="line">	npreleased  uintptr    // number <span class="keyword">of</span> pages released to the os</div><div class="line">	limit       uintptr    // <span class="keyword">end</span> <span class="keyword">of</span> data <span class="keyword">in</span> span</div><div class="line">	speciallock mutex      // guards specials list</div><div class="line">	specials    *special   // linked list <span class="keyword">of</span> special records sorted by offset.</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>里边比较重要的几个点：</p><ul><li>freeindex<br>介于0~nelems的可用块的索引位置，是下一个可用块的位置;在freeindex之前的块都是已分配的，之后的可能已分配，可能未分配。</li><li>allocBits<br>标记span中可用内存位置的bitmap，1标识可用</li><li>allocCache<br>缓存了从freeindex开始的allocBits的bit位补集，这样分配前使用count tailing zero方式可快速定位地址<br>（关于count tailing zero的实现，感兴趣同学可以看下sys.Ctz64的实现）</li><li>spanclass<br>代表span的大小和是否需要gc扫描（既包含指针）</li><li>elemsize<br>小对象对应是sizeClass对应的块大小；大对象，对应是整数页的大小</li></ul><h3 id="mcache"><a href="#mcache" class="headerlink" title="mcache"></a>mcache</h3><p>go中每个P(GMP中的P，是系统线程M绑定的用来调度G的处理器，同一时间只有一个M可以拥有P)中用来缓存小对象的结构，无需加锁；<br>每个mcache中有大小为67个mspan数组，存储不同级别大小的mspan<br>可以理解为local cache<br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> mcache <span class="keyword">struct</span> &#123;</div><div class="line">	next_sample <span class="keyword">int32</span>   <span class="comment">// trigger heap sample after allocating this many bytes</span></div><div class="line">	local_scan  <span class="keyword">uintptr</span> <span class="comment">// bytes of scannable heap allocated</span></div><div class="line"></div><div class="line">	tiny             <span class="keyword">uintptr</span></div><div class="line">	tinyoffset       <span class="keyword">uintptr</span></div><div class="line">	local_tinyallocs <span class="keyword">uintptr</span> <span class="comment">// number of tiny allocs not counted in other stats</span></div><div class="line"></div><div class="line">	<span class="comment">// The rest is not accessed on every malloc.</span></div><div class="line"></div><div class="line">	alloc [numSpanClasses]*mspan <span class="comment">// spans to allocate from, indexed by spanClass</span></div><div class="line"></div><div class="line">	stackcache [_NumStackOrders]stackfreelist</div><div class="line"></div><div class="line">	<span class="comment">// Local allocator stats, flushed during GC.</span></div><div class="line">	local_nlookup    <span class="keyword">uintptr</span>                  <span class="comment">// number of pointer lookups</span></div><div class="line">	local_largefree  <span class="keyword">uintptr</span>                  <span class="comment">// bytes freed for large objects (&gt;maxsmallsize)</span></div><div class="line">	local_nlargefree <span class="keyword">uintptr</span>                  <span class="comment">// number of frees for large objects (&gt;maxsmallsize)</span></div><div class="line">	local_nsmallfree [_NumSizeClasses]<span class="keyword">uintptr</span> <span class="comment">// number of frees for small objects (&lt;=maxsmallsize)</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>alloc<br>是大小为67的指针数组，每个数组包含特定大小的块。</li><li>tiny<br>指向mcache内存开始地址</li><li>tinyoffset<br>记录tiny分配到什么位置（tiny对象分配完有剩余是，offset可用于下次分配计算）<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">每个sizeClass对应的大小（byte）</div><div class="line"><span class="comment">// sizeclasses.go</span></div><div class="line">var class_to_size = [_NumSizeClasses]uint16&#123;<span class="number">0</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">48</span>, <span class="number">64</span>, <span class="number">80</span>, <span class="number">96</span>, <span class="number">112</span>, <span class="number">128</span>, <span class="number">144</span>, <span class="number">160</span>, <span class="number">176</span>, <span class="number">192</span>, <span class="number">208</span>, <span class="number">224</span>, <span class="number">240</span>, <span class="number">256</span>, <span class="number">288</span>, <span class="number">320</span>, <span class="number">352</span>, <span class="number">384</span>, <span class="number">416</span>, <span class="number">448</span>, <span class="number">480</span>, <span class="number">512</span>, <span class="number">576</span>, <span class="number">640</span>, <span class="number">704</span>, <span class="number">768</span>, <span class="number">896</span>, <span class="number">1024</span>, <span class="number">1152</span>, <span class="number">1280</span>, <span class="number">1408</span>, <span class="number">1536</span>, <span class="number">1792</span>, <span class="number">2048</span>, <span class="number">2304</span>, <span class="number">2688</span>, <span class="number">3072</span>, <span class="number">3200</span>, <span class="number">3456</span>, <span class="number">4096</span>, <span class="number">4864</span>, <span class="number">5376</span>, <span class="number">6144</span>, <span class="number">6528</span>, <span class="number">6784</span>, <span class="number">6912</span>, <span class="number">8192</span>, <span class="number">9472</span>, <span class="number">9728</span>, <span class="number">10240</span>, <span class="number">10880</span>, <span class="number">12288</span>, <span class="number">13568</span>, <span class="number">14336</span>, <span class="number">16384</span>, <span class="number">18432</span>, <span class="number">19072</span>, <span class="number">20480</span>, <span class="number">21760</span>, <span class="number">24576</span>, <span class="number">27264</span>, <span class="number">28672</span>, <span class="number">32768</span>&#125;</div></pre></td></tr></table></figure></li></ul><h3 id="mcentral"><a href="#mcentral" class="headerlink" title="mcentral"></a>mcentral</h3><p>是指定大小的可用对象列表中枢<br>mcache不够用时，从mcentral分配nonempty中的span对象，每次分配时同时会处理可回收的span进行回收。<br>如果无可用span，则从heap中按需要的spanclass申请新的span</p><p>可理解为全局cache<br></p><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> mcentral struct &#123;</div><div class="line">	lock      mutex</div><div class="line">	spanclass spanClass</div><div class="line">	nonempty  mSpanList // list <span class="keyword">of</span> spans <span class="keyword">with</span> a free <span class="keyword">object</span>, ie a nonempty free list</div><div class="line">	empty     mSpanList // list <span class="keyword">of</span> spans <span class="keyword">with</span> no free objects (<span class="keyword">or</span> cached <span class="keyword">in</span> an mcache)</div><div class="line">	nmalloc <span class="built_in">uint64</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>nonempty<br>链接可用对象的链表</li><li>empty<br>已被使用对象的列表</li><li>nmalloc<br>mcentral累计分配出去的对象数</li></ul><h3 id="mheap"><a href="#mheap" class="headerlink" title="mheap"></a>mheap</h3><p>真实拥有虚拟地址的，管理小对象和大对象的内存分配，以及一些全局变量<br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> mheap <span class="keyword">struct</span> &#123;</div><div class="line">	lock      mutex</div><div class="line">	free      [_MaxMHeapList]mSpanList <span class="comment">// free lists of given length up to _MaxMHeapList</span></div><div class="line">	freelarge mTreap                   <span class="comment">// free treap of length &gt;= _MaxMHeapList</span></div><div class="line">	busy      [_MaxMHeapList]mSpanList <span class="comment">// busy lists of large spans of given length</span></div><div class="line">	busylarge mSpanList                <span class="comment">// busy lists of large spans length &gt;= _MaxMHeapList</span></div><div class="line">	sweepgen  <span class="keyword">uint32</span>                   <span class="comment">// sweep generation, see comment in mspan</span></div><div class="line">	sweepdone <span class="keyword">uint32</span>                   <span class="comment">// all spans are swept</span></div><div class="line">	sweepers  <span class="keyword">uint32</span>                   <span class="comment">// number of active sweepone calls</span></div><div class="line"></div><div class="line">	allspans []*mspan <span class="comment">// all spans out there</span></div><div class="line">	spans []*mspan</div><div class="line"></div><div class="line">	sweepSpans [<span class="number">2</span>]gcSweepBuf</div><div class="line"></div><div class="line">	_ <span class="keyword">uint32</span> <span class="comment">// align uint64 fields on 32-bit for atomics</span></div><div class="line">	pagesInUse         <span class="keyword">uint64</span>  <span class="comment">// pages of spans in stats _MSpanInUse; R/W with mheap.lock</span></div><div class="line">	pagesSwept         <span class="keyword">uint64</span>  <span class="comment">// pages swept this cycle; updated atomically</span></div><div class="line">	pagesSweptBasis    <span class="keyword">uint64</span>  <span class="comment">// pagesSwept to use as the origin of the sweep ratio; updated atomically</span></div><div class="line">	sweepHeapLiveBasis <span class="keyword">uint64</span>  <span class="comment">// value of heap_live to use as the origin of sweep ratio; written with lock, read without</span></div><div class="line">	sweepPagesPerByte  <span class="keyword">float64</span> <span class="comment">// proportional sweep ratio; written with lock, read without</span></div><div class="line">	<span class="comment">// Malloc stats.</span></div><div class="line">	largealloc  <span class="keyword">uint64</span>                  <span class="comment">// bytes allocated for large objects</span></div><div class="line">	nlargealloc <span class="keyword">uint64</span>                  <span class="comment">// number of large object allocations</span></div><div class="line">	largefree   <span class="keyword">uint64</span>                  <span class="comment">// bytes freed for large objects (&gt;maxsmallsize)</span></div><div class="line">	nlargefree  <span class="keyword">uint64</span>                  <span class="comment">// number of frees for large objects (&gt;maxsmallsize)</span></div><div class="line">	nsmallfree  [_NumSizeClasses]<span class="keyword">uint64</span> <span class="comment">// number of frees for small objects (&lt;=maxsmallsize)</span></div><div class="line"></div><div class="line">	<span class="comment">// range of addresses we might see in the heap</span></div><div class="line">	bitmap        <span class="keyword">uintptr</span> <span class="comment">// Points to one byte past the end of the bitmap</span></div><div class="line">	bitmap_mapped <span class="keyword">uintptr</span></div><div class="line"></div><div class="line">	arena_start <span class="keyword">uintptr</span></div><div class="line">	arena_used  <span class="keyword">uintptr</span> <span class="comment">// Set with setArenaUsed.</span></div><div class="line"></div><div class="line">	arena_alloc <span class="keyword">uintptr</span></div><div class="line">	arena_end   <span class="keyword">uintptr</span></div><div class="line">	arena_reserved <span class="keyword">bool</span></div><div class="line"></div><div class="line">	_ <span class="keyword">uint32</span> <span class="comment">// ensure 64-bit alignment</span></div><div class="line"></div><div class="line">	central [numSpanClasses]<span class="keyword">struct</span> &#123;</div><div class="line">		mcentral mcentral</div><div class="line">		pad      [sys.CacheLineSize - unsafe.Sizeof(mcentral&#123;&#125;)%sys.CacheLineSize]<span class="keyword">byte</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	spanalloc             fixalloc <span class="comment">// allocator for span*</span></div><div class="line">	cachealloc            fixalloc <span class="comment">// allocator for mcache*</span></div><div class="line">	treapalloc            fixalloc <span class="comment">// allocator for treapNodes* used by large objects</span></div><div class="line">	specialfinalizeralloc fixalloc <span class="comment">// allocator for specialfinalizer*</span></div><div class="line">	specialprofilealloc   fixalloc <span class="comment">// allocator for specialprofile*</span></div><div class="line">	speciallock           mutex    <span class="comment">// lock for special record allocators.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>free<br>记录小对象分配</li><li>freelarge<br>记录大对象分配（&gt;32k）,mTreap是基于BestFit分配算法实现的树堆。树堆中每个节点是一整个span，树堆按页大小排序，页大小相同时按内存起始地址排序。<br>基于BestFit算法返回span时，如果span大小相同，先返回在地址最小的span。<br>详见mgclarge.go</li><li>allspans<br>每个分配出的span</li><li>spans<br>映射mspan和arena的page对应关系的查询表（如前所说span一个指针对应bitmap一页）</li><li>central<br>用于管理小对象的空闲链表，按spanClass索引</li><li>arena_start,arena_used<br>记录areana分配</li></ul><p>注意到其中span,cache,treap都是用fixalloc来分配,这是一个free-list的块分配器，用来分配指定大小的块。<br></p><figure class="highlight rust"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">type</span> <span class="title">fixalloc</span></span> <span class="class"><span class="keyword">struct</span> &#123;</span></div><div class="line">	size   uintptr</div><div class="line">	first  func(arg, p <span class="keyword">unsafe</span>.Pointer) <span class="comment">// called first time p is returned</span></div><div class="line">	arg    <span class="keyword">unsafe</span>.Pointer</div><div class="line">	list   *mlink</div><div class="line">	chunk  uintptr <span class="comment">// use uintptr instead of unsafe.Pointer to avoid write barriers</span></div><div class="line">	nchunk uint32</div><div class="line">	inuse  uintptr <span class="comment">// in-use bytes now</span></div><div class="line">	stat   *uint64</div><div class="line">	zero   <span class="built_in">bool</span> <span class="comment">// zero allocations</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><p>分配时，如果list为空，则申请一整块内存（chunk），每次按需分配；释放时再放回list中。<br>因为size是固定，所以没有内存碎片产生。</p><h2 id="内存分配流程"><a href="#内存分配流程" class="headerlink" title="内存分配流程"></a>内存分配流程</h2><p><img src="http://media.newbmiao.com/blog/malloc.png" alt="malloc"></p><h3 id="对象分配"><a href="#对象分配" class="headerlink" title="对象分配"></a>对象分配</h3><ul><li>size &gt; 32k,是大对象，直接从mheap中分配</li><li>size &lt; 16B,使用mcache的tiny allocator分配，将小对象合并存储<br>分配前会按大小先地址对齐<br>1.对于大于等于8B的对象，其内存地址按照8B对齐;<br>2.对于小于8B大于等于4B的对象，其内存地址按照4B对齐;<br>3.对于小于4B大于1B的对象，其内存地址按照2B对齐;<br>4.对于1B对象，无对齐要求。<br><strong>这样对齐会有部分内存浪费，但却能提升内存访问的效率。</strong></li><li>size 在16B ~ 32k 间，计算需要使用的sizeClass，然后使用mcache中对应的sizeClass的块分配</li><li>如果mcache对应的sizeClass已无可用块，则向mcentral申请</li><li>如果mcentral也没有可用的块，则向mheap申请，使用BestFit找到最合适的mspan。如果超过申请大小则按需切分，返回用户需要的页面数，剩余的页面构成一个新的mspan，放回mheap的空闲链表</li><li>如果mheap也无可用span，则向操作系统申请一组新的页(至少1MB)</li></ul><h3 id="对象释放"><a href="#对象释放" class="headerlink" title="对象释放"></a>对象释放</h3><ul><li>查找对象所属的类型大小，放入对应的mcache空闲链表</li><li>如果mcache空闲链表太长或者内存太大，则返回给mcentral的空闲链表</li><li>如果在某个范围的所有对象都归还给mcentral了，则将他归还给mheap</li></ul><p>具体见runtime/mgcsweep.go mspan.sweep,这里不展开</p><p>下面结合源码看下分配流程<br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">newobject</span><span class="params">(typ *_type)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> mallocgc(typ.size, typ, <span class="literal">true</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgc</span><span class="params">(size <span class="keyword">uintptr</span>, typ *_type, needzero <span class="keyword">bool</span>)</span> <span class="title">unsafe</span>.<span class="title">Pointer</span></span> &#123;</div><div class="line">	...</div><div class="line">    </div><div class="line">	dataSize := size</div><div class="line">	c := gomcache()</div><div class="line">	<span class="keyword">var</span> x unsafe.Pointer</div><div class="line">	noscan := typ == <span class="literal">nil</span> || typ.kind&amp;kindNoPointers != <span class="number">0</span></div><div class="line">	<span class="keyword">if</span> size &lt;= maxSmallSize &#123;</div><div class="line">    	<span class="comment">//极小对象（小于16byte，这个大小设置是综合考虑小对象合并和内存浪费得出）</span></div><div class="line">		<span class="keyword">if</span> noscan &amp;&amp; size &lt; maxTinySize &#123;</div><div class="line">			off := c.tinyoffset</div><div class="line">            <span class="comment">//地址对齐</span></div><div class="line">			<span class="keyword">if</span> size&amp;<span class="number">7</span> == <span class="number">0</span> &#123;</div><div class="line">				off = round(off, <span class="number">8</span>)</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">3</span> == <span class="number">0</span> &#123;</div><div class="line">				off = round(off, <span class="number">4</span>)</div><div class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> size&amp;<span class="number">1</span> == <span class="number">0</span> &#123;</div><div class="line">				off = round(off, <span class="number">2</span>)</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">if</span> off+size &lt;= maxTinySize &amp;&amp; c.tiny != <span class="number">0</span> &#123;</div><div class="line">				<span class="comment">// 剩余空间够用，就拼在后边</span></div><div class="line">				x = unsafe.Pointer(c.tiny + off)</div><div class="line">				c.tinyoffset = off + size</div><div class="line">				c.local_tinyallocs++</div><div class="line">				mp.mallocing = <span class="number">0</span></div><div class="line">				releasem(mp)</div><div class="line">				<span class="keyword">return</span> x</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// 不够用，就新申请mspan</span></div><div class="line">			span := c.alloc[tinySpanClass]</div><div class="line">			v := nextFreeFast(span)</div><div class="line">			<span class="keyword">if</span> v == <span class="number">0</span> &#123;</div><div class="line">				v, _, shouldhelpgc = c.nextFree(tinySpanClass)</div><div class="line">			&#125;</div><div class="line">			x = unsafe.Pointer(v)</div><div class="line">			(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">0</span>] = <span class="number">0</span></div><div class="line">			(*[<span class="number">2</span>]<span class="keyword">uint64</span>)(x)[<span class="number">1</span>] = <span class="number">0</span></div><div class="line">			<span class="comment">// See if we need to replace the existing tiny block with the new one</span></div><div class="line">			<span class="comment">// based on amount of remaining free space.</span></div><div class="line">			<span class="keyword">if</span> size &lt; c.tinyoffset || c.tiny == <span class="number">0</span> &#123;</div><div class="line">				c.tiny = <span class="keyword">uintptr</span>(x)</div><div class="line">				c.tinyoffset = size</div><div class="line">			&#125;</div><div class="line">			size = maxTinySize</div><div class="line">		&#125; <span class="keyword">else</span> &#123;</div><div class="line">        	<span class="comment">//小对象（16byte ~ 32k）</span></div><div class="line">            <span class="comment">//计算对应的sizeclass</span></div><div class="line">			<span class="keyword">var</span> sizeclass <span class="keyword">uint8</span></div><div class="line">			<span class="keyword">if</span> size &lt;= smallSizeMax<span class="number">-8</span> &#123;</div><div class="line">				sizeclass = size_to_class8[(size+smallSizeDiv<span class="number">-1</span>)/smallSizeDiv]</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				sizeclass = size_to_class128[(size-smallSizeMax+largeSizeDiv<span class="number">-1</span>)/largeSizeDiv]</div><div class="line">			&#125;</div><div class="line">			size = <span class="keyword">uintptr</span>(class_to_size[sizeclass])</div><div class="line">			spc := makeSpanClass(sizeclass, noscan)</div><div class="line">			span := c.alloc[spc]</div><div class="line">			v := nextFreeFast(span)</div><div class="line">			<span class="keyword">if</span> v == <span class="number">0</span> &#123;</div><div class="line">				v, span, shouldhelpgc = c.nextFree(spc)</div><div class="line">			&#125;</div><div class="line">			x = unsafe.Pointer(v)</div><div class="line">			<span class="keyword">if</span> needzero &amp;&amp; span.needzero != <span class="number">0</span> &#123;</div><div class="line">				memclrNoHeapPointers(unsafe.Pointer(v), size)</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">    	<span class="comment">//大对象 （&gt;32k）</span></div><div class="line">		<span class="keyword">var</span> s *mspan</div><div class="line">		shouldhelpgc = <span class="literal">true</span></div><div class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			s = largeAlloc(size, needzero, noscan)</div><div class="line">		&#125;)</div><div class="line">		s.freeindex = <span class="number">1</span></div><div class="line">		s.allocCount = <span class="number">1</span></div><div class="line">		x = unsafe.Pointer(s.base())</div><div class="line">		size = s.elemsize</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	...</div><div class="line">    </div><div class="line">	<span class="keyword">return</span> x</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//分配小对象和极小对象，无可用返回0</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">nextFreeFast</span><span class="params">(s *mspan)</span> <span class="title">gclinkptr</span></span> &#123;</div><div class="line">	<span class="comment">//计算allocCache低位起有多少个0</span></div><div class="line">	theBit := sys.Ctz64(s.allocCache) <span class="comment">// Is there a free object in the allocCache?</span></div><div class="line">	<span class="keyword">if</span> theBit &lt; <span class="number">64</span> &#123;</div><div class="line">		result := s.freeindex + <span class="keyword">uintptr</span>(theBit)</div><div class="line">		<span class="keyword">if</span> result &lt; s.nelems &#123;</div><div class="line">        	<span class="comment">//freeindex后移</span></div><div class="line">			freeidx := result + <span class="number">1</span></div><div class="line">			<span class="keyword">if</span> freeidx%<span class="number">64</span> == <span class="number">0</span> &amp;&amp; freeidx != s.nelems &#123;</div><div class="line">				<span class="keyword">return</span> <span class="number">0</span></div><div class="line">			&#125;</div><div class="line">			s.allocCache &gt;&gt;= <span class="keyword">uint</span>(theBit + <span class="number">1</span>)</div><div class="line">			s.freeindex = freeidx</div><div class="line">			s.allocCount++</div><div class="line">			<span class="keyword">return</span> gclinkptr(result*s.elemsize + s.base())</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//span不足，获取mcache的span分配；如还不足，则依次向mcentral-&gt;mheap-&gt;sysAlloc 的顺序申请，直到获得可用span (后续申请不在此展开)</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *mcache)</span> <span class="title">nextFree</span><span class="params">(spc spanClass)</span> <span class="params">(v gclinkptr, s *mspan, shouldhelpgc <span class="keyword">bool</span>)</span></span> &#123;</div><div class="line">	s = c.alloc[spc]</div><div class="line">	shouldhelpgc = <span class="literal">false</span></div><div class="line">	freeIndex := s.nextFreeIndex()</div><div class="line">	<span class="keyword">if</span> freeIndex == s.nelems &#123;</div><div class="line">		<span class="comment">// The span is full.</span></div><div class="line">		<span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) != s.nelems &#123;</div><div class="line">			<span class="built_in">println</span>(<span class="string">"runtime: s.allocCount="</span>, s.allocCount, <span class="string">"s.nelems="</span>, s.nelems)</div><div class="line">			throw(<span class="string">"s.allocCount != s.nelems &amp;&amp; freeIndex == s.nelems"</span>)</div><div class="line">		&#125;</div><div class="line">		systemstack(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        	<span class="comment">//向mcentral获取可用地址</span></div><div class="line">			c.refill(spc)</div><div class="line">		&#125;)</div><div class="line">		shouldhelpgc = <span class="literal">true</span></div><div class="line">		s = c.alloc[spc]</div><div class="line"></div><div class="line">		freeIndex = s.nextFreeIndex()</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> freeIndex &gt;= s.nelems &#123;</div><div class="line">		throw(<span class="string">"freeIndex is not valid"</span>)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	v = gclinkptr(freeIndex*s.elemsize + s.base())</div><div class="line">	s.allocCount++</div><div class="line">	<span class="keyword">if</span> <span class="keyword">uintptr</span>(s.allocCount) &gt; s.nelems &#123;</div><div class="line">		<span class="built_in">println</span>(<span class="string">"s.allocCount="</span>, s.allocCount, <span class="string">"s.nelems="</span>, s.nelems)</div><div class="line">		throw(<span class="string">"s.allocCount &gt; s.nelems"</span>)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//大对象直接heap分配</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">largeAlloc</span><span class="params">(size <span class="keyword">uintptr</span>, needzero <span class="keyword">bool</span>, noscan <span class="keyword">bool</span>)</span> *<span class="title">mspan</span></span> &#123;</div><div class="line">	<span class="comment">// print("largeAlloc size=", size, "\n")</span></div><div class="line"></div><div class="line">	<span class="keyword">if</span> size+_PageSize &lt; size &#123;</div><div class="line">		throw(<span class="string">"out of memory"</span>)</div><div class="line">	&#125;</div><div class="line">	npages := size &gt;&gt; _PageShift</div><div class="line">	<span class="keyword">if</span> size&amp;_PageMask != <span class="number">0</span> &#123;</div><div class="line">		npages++</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Deduct credit for this span allocation and sweep if</span></div><div class="line">	<span class="comment">// necessary. mHeap_Alloc will also sweep npages, so this only</span></div><div class="line">	<span class="comment">// pays the debt down to npage pages.</span></div><div class="line">	deductSweepCredit(npages*_PageSize, npages)</div><div class="line"></div><div class="line">	s := mheap_.alloc(npages, makeSpanClass(<span class="number">0</span>, noscan), <span class="literal">true</span>, needzero)</div><div class="line">	<span class="keyword">if</span> s == <span class="literal">nil</span> &#123;</div><div class="line">		throw(<span class="string">"out of memory"</span>)</div><div class="line">	&#125;</div><div class="line">	s.limit = s.base() + size</div><div class="line">	heapBitsForSpan(s.base()).initSpan(s)</div><div class="line">	<span class="keyword">return</span> s</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Go内存管理内存池的总体思路是，针对不同大小的对象，使用不同的内存结构分配内存。对操作系统申请的一整块连续地址，进行切分，多级缓存。对内存分配都按规定大小分配，减少内存碎片，也利于内存释放后，回收管理。</p><p>针对小对象(&lt; 16byte)，使用当前调度器（p）的mcache中的tiny allocator来分配，这样多个小对象可以放一起管理，避免内存浪费。<br>针对稍大对象（16byte ~ 32K）,是用指定sizeClass取对应的块来分配。<br>针对大对象（&gt;32K），直接从heap中分配</p><p>其中mcache不足向mcentral中申请、mcentral不足向mheap申请，这些请求都是一次申请平摊了加锁（mcentral或mheap）的开销；<br>mheap不足向操作系统申请一组页，则是平摊了操作系统分配的开销；</p><p>同时设计mcentral - 全局的cache 和 mcache - 每个调度器cache，便于中小对象快速分配和回收，提高内存分配的效率，避免每次和操作系统申请的io开销，是用空间换时间的方式。</p><p>参考</p><blockquote><p><a href="http://www.cnblogs.com/zkweb/p/7880099.html" target="_blank" rel="external">http://www.cnblogs.com/zkweb/p/7880099.html</a><br><a href="https://studygolang.com/articles/11030" target="_blank" rel="external">https://studygolang.com/articles/11030</a><br><a href="http://www.cnblogs.com/zkweb/p/7880099.html" target="_blank" rel="external">http://www.cnblogs.com/zkweb/p/7880099.html</a></p></blockquote><blockquote style="padding:10px;background:#efe none repeat scroll 0 0;border-left-color:green">如有疑问，请留言或邮件<a href="mailto:newbvirgil@gmail.com" title="newbvirgil@gmail.com">newbvirgil@gmail.com</a><br>本文链接 : <a href="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html" title="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html" target="_blank" rel="external">http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html</a></blockquote></div><footer class="article-footer"><a data-url="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html" data-id="cjqmzu56j008vn731gjxyztjd" class="article-share-link" data-share="baidu">分享到</a> <a href="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html#disqus_thread" class="article-comment-link">评论</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul><span id="busuanzi_container_page_pv" style="color:#999"><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>次阅读 </span><span style="color:#999">&nbsp; | &nbsp;最近更新 ：<time datetime="2018-10-05T06:49:08.835Z" itemprop="dateModify">2018-10-05</time></span></footer></div></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">近期文章</h3><div class="widget"><ul><li><a href="/2018/08/20/go-source-analysis-of-memory-alloc.html">go源码分析之内存分配</a></li><li><a href="/2018/03/15/go-value-layout-in-memory.html">go学习之类型的数据结构内存分布</a></li><li><a href="/2018/03/05/go-value-in-heap-and-stack.html">go学习之堆栈中的变量</a></li><li><a href="/2018/02/09/advanced-go-concurrency-patterns.html">Advanced Go Concurrency Patterns</a></li><li><a href="/2018/02/06/go-memory-model.html">Go Memory Model</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/dropbox/">dropbox</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/hexo/">hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/gearman/">gearman</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/go/notes/">notes</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/">html5</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/journal/">journal</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/jquery/">jquery</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/notes/">notes</a><span class="category-list-count">7</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mac/shadowsocks/">shadowsocks</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/tool/">tool</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/optimize/">optimize</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/php/CI/">CI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/regex/">regex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/signal/">signal</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/tool/">tool</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/notes/">notes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/practice/">practice</a><span class="category-list-count">4</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"><a href="/tags/hexo/" style="font-size:18.33px;color:#2c93ea">hexo</a> <a href="/tags/blog/" style="font-size:20px;color:#3495df">blog</a> <a href="/tags/gitcafe/" style="font-size:15px;color:#1e90ff">gitcafe</a> <a href="/tags/gearman/" style="font-size:15px;color:#1e90ff">gearman</a> <a href="/tags/go/" style="font-size:23.33px;color:#4298ca">go</a> <a href="/tags/happens-before/" style="font-size:15px;color:#1e90ff">happens-before</a> <a href="/tags/slice/" style="font-size:15px;color:#1e90ff">slice</a> <a href="/tags/panic/" style="font-size:15px;color:#1e90ff">panic</a> <a href="/tags/journal/" style="font-size:16.67px;color:#2592f4">journal</a> <a href="/tags/html5/" style="font-size:16.67px;color:#2592f4">html5</a> <a href="/tags/drag/" style="font-size:16.67px;color:#2592f4">drag</a> <a href="/tags/chrome/" style="font-size:15px;color:#1e90ff">chrome</a> <a href="/tags/js/" style="font-size:30px;color:#5f9ea0">js</a> <a href="/tags/javascript-program-solution/" style="font-size:18.33px;color:#2c93ea">javascript-program-solution</a> <a href="/tags/random/" style="font-size:15px;color:#1e90ff">random</a> <a href="/tags/maintainable-javascript/" style="font-size:15px;color:#1e90ff">maintainable-javascript</a> <a href="/tags/git/" style="font-size:15px;color:#1e90ff">git</a> <a href="/tags/linux/" style="font-size:26.67px;color:#519bb5">linux</a> <a href="/tags/mac/" style="font-size:18.33px;color:#2c93ea">mac</a> <a href="/tags/vim/" style="font-size:15px;color:#1e90ff">vim</a> <a href="/tags/tool/" style="font-size:15px;color:#1e90ff">tool</a> <a href="/tags/shadowsocks/" style="font-size:15px;color:#1e90ff">shadowsocks</a> <a href="/tags/software/" style="font-size:15px;color:#1e90ff">software</a> <a href="/tags/mysql/" style="font-size:20px;color:#3495df">mysql</a> <a href="/tags/limit/" style="font-size:15px;color:#1e90ff">limit</a> <a href="/tags/imgick/" style="font-size:15px;color:#1e90ff">imgick</a> <a href="/tags/json/" style="font-size:15px;color:#1e90ff">json</a> <a href="/tags/blob/" style="font-size:15px;color:#1e90ff">blob</a> <a href="/tags/phpdoc/" style="font-size:15px;color:#1e90ff">phpdoc</a> <a href="/tags/php/" style="font-size:28.33px;color:#589cab">php</a> <a href="/tags/target/" style="font-size:15px;color:#1e90ff">target</a> <a href="/tags/reference/" style="font-size:15px;color:#1e90ff">reference</a> <a href="/tags/function/" style="font-size:15px;color:#1e90ff">function</a> <a href="/tags/apache/" style="font-size:15px;color:#1e90ff">apache</a> <a href="/tags/redis/" style="font-size:15px;color:#1e90ff">redis</a> <a href="/tags/regex/" style="font-size:15px;color:#1e90ff">regex</a> <a href="/tags/php-fpm/" style="font-size:15px;color:#1e90ff">php-fpm</a> <a href="/tags/dropbox/" style="font-size:15px;color:#1e90ff">dropbox</a> <a href="/tags/jquery/" style="font-size:21.67px;color:#3b96d5">jquery</a> <a href="/tags/iframe/" style="font-size:15px;color:#1e90ff">iframe</a> <a href="/tags/closure/" style="font-size:15px;color:#1e90ff">closure</a> <a href="/tags/cors/" style="font-size:15px;color:#1e90ff">cors</a> <a href="/tags/concurrency/" style="font-size:15px;color:#1e90ff">concurrency</a> <a href="/tags/jquery-timepicker-addon/" style="font-size:15px;color:#1e90ff">jquery-timepicker-addon</a> <a href="/tags/ajax/" style="font-size:15px;color:#1e90ff">ajax</a> <a href="/tags/promise/" style="font-size:15px;color:#1e90ff">promise</a> <a href="/tags/notes/" style="font-size:25px;color:#4999c0">notes</a> <a href="/tags/CI/" style="font-size:15px;color:#1e90ff">CI</a> <a href="/tags/pcntl/" style="font-size:15px;color:#1e90ff">pcntl</a> <a href="/tags/signal/" style="font-size:15px;color:#1e90ff">signal</a> <a href="/tags/laradock/" style="font-size:15px;color:#1e90ff">laradock</a> <a href="/tags/docker/" style="font-size:15px;color:#1e90ff">docker</a> <a href="/tags/xdebug/" style="font-size:15px;color:#1e90ff">xdebug</a></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">友情链接</h3><div class="widget"><ul><li><a href="http://coolshell.cn/" target="_blank">酷壳</a></li><li><a href="http://leo108.com/" target="_blank">leo108</a></li><li><a href="http://www.cnblogs.com/liaoziyu/" target="_blank">大粨兔奶糖</a></li><li><a href="http://blog.ihuxu.com/" target="_blank">胡小旭</a></li><li><a href="http://bin.bloggao.cn/" target="_blank">liecol-晓斌</a></li><li><a href="http://xianfengsong.github.io/" target="_blank">先锋Song</a></li><li><a href="https://qwd.jd.com/previewShop.shtml?isNoCheckPlatProtocol=1&shopid=1828197" target="_blank">新喵杂货铺</a></li></ul></div></div><div class="widget-wrap widget-toc" style="display:none"><h3 class="widget-title">文章目录</h3><div class="container widget" style="padding:15px 20px"></div></div><script src="//media.newbmiao.com/blog/asset/js/toc.js"></script></aside></div><footer id="footer"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="outer"><div id="footer-info" class="inner">&copy; 2019 菜鸟Miao<br><p><span id="busuanzi_container_site_uv">您是本站第<span id="busuanzi_value_site_uv"> <i class="fa fa-spinner fa-spin"></i></span>个访问者 </span><span id="busuanzi_container_site_pv">/本站总访问量<span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i> </span>次</span></p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> . Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a> . Hosted by <a href="https://pages.coding.me" style="font-weight:700" target="_blank">Coding Pages</a> &amp; <a href="https://github.com/newbmiao" target="_blank" style="font-weight:700">GitHub Pages</a> .</div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a> <a href="/add-ons" class="mobile-nav-link">小玩意</a> <a href="/invest" class="mobile-nav-link">投资</a> <a href="/book" class="mobile-nav-link">书单</a></nav><script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script><div id="totop"><a title="返回顶部"><img src="/img/scrollup.png"></a></div><script>var disqus_shortname="newbmiao",disqus_url="http://blog.newbmiao.com/2018/08/20/go-source-analysis-of-memory-alloc.html";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><div id="article-share-box" class="article-share-box"><div id="bdshare" class="bdsharebuttonbox article-share-links"><a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a> <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a> <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a> <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a> <a class="article-share-more" data-cmd="more" title="更多"></a></div></div><script>with(window._bd_share_config={common:{},share:{bdCustomStyle:"/css/bdshare.css"}},document)(0)[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)]</script><link rel="stylesheet" href="//media.newbmiao.com/blog/asset/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="//media.newbmiao.com/blog/asset/fancybox/jquery.fancybox.pack.js"></script><script src="//media.newbmiao.com/blog/asset/js/script.js"></script><script type="text/javascript">!function(t,e,n,s,c,i,o){t.SwiftypeObject=c,t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},i=e.createElement(n),o=e.getElementsByTagName(n)[0],i.async=1,i.src=s,o.parentNode.insertBefore(i,o)}(window,document,"script","//s.swiftypecdn.com/install/v2/st.js","_st"),_st("install","bqAniPPC1T7RV4MomxcE","2.0.0")</script></div></body><!-- rebuild by neat -->