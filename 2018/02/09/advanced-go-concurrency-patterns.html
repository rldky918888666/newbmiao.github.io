<!-- build time:Fri Oct 05 2018 14:52:46 GMT+0800 (CST) --><!DOCTYPE html><html><head><meta charset="utf-8"><title>Advanced Go Concurrency Patterns | 菜鸟Miao</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="google-site-verification" content="q90Bd4BGjQuSBoXdzK6CUCB8mMUeCEO6MKbaCQS773E"><meta name="keywords" itemprop="keywords" content="go,concurrency,select,block,parallelism,pattern"><meta name="description" content="advanced-go-concurrency-patterns"><meta name="keywords" content="go,concurrency,select,block,parallelism,pattern"><meta property="og:type" content="article"><meta property="og:title" content="Advanced Go Concurrency Patterns"><meta property="og:url" content="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html"><meta property="og:site_name" content="菜鸟Miao"><meta property="og:description" content="advanced-go-concurrency-patterns"><meta property="og:updated_time" content="2018-10-05T06:49:08.832Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Advanced Go Concurrency Patterns"><meta name="twitter:description" content="advanced-go-concurrency-patterns"><link rel="alternative" href="/atom.xml" title="菜鸟Miao" type="application/atom+xml"><link rel="icon" href="http://media.newbmiao.com/blog/asset/favicon.ico"><link rel="stylesheet" href="//media.newbmiao.com/blog/asset/css/style.css" type="text/css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css"><!--[if lt IE 9]><script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7/html5shiv.min.js"></script><![endif]--></head></html><body><div id="container"><div id="wrap"><header id="header"><div id="banner"></div><div id="header-outer" class="outer"><div id="header-title" class="inner"><h1 id="logo-wrap"><a href="/" id="logo">菜鸟Miao</a></h1><h2 id="subtitle-wrap"><a href="/" id="subtitle">start from a newb...</a></h2></div><div id="header-inner" class="inner"><nav id="main-nav"><a id="main-nav-toggle" class="nav-icon"></a> <a class="main-nav-link" href="/">Home</a> <a class="main-nav-link" href="/archives">Archives</a> <a class="main-nav-link" href="/add-ons">Add-ons</a> <a class="main-nav-link" href="/invest">Invest</a></nav><nav id="sub-nav"><a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a> <a id="nav-search-btn" class="nav-icon" title="Search"></a></nav><div id="search-form-wrap"><div id="search-form"><input type="text" class="st-default-search-input search-form-input" style="outline:0;width:110px"></div></div></div></div></header><div class="outer"><section id="main"><article id="post-advanced-go-concurrency-patterns" class="article article-type-post" itemscope itemprop="blogPost"><div class="article-meta"><a href="/2018/02/09/advanced-go-concurrency-patterns.html" class="article-date"><time datetime="2018-02-09T07:50:36.000Z" itemprop="datePublished">2018-02-09</time></a><div class="article-category"><a class="article-category-link" href="/categories/go/">go</a>►<a class="article-category-link" href="/categories/go/notes/">notes</a></div></div><div class="article-inner"><header class="article-header"><h1 class="article-title" itemprop="name">Advanced Go Concurrency Patterns</h1></header><div class="article-entry" itemprop="articleBody"><div id="toc" class="toc-article"><h3>文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Concurrency-Is-Not-Parallelism"><span class="toc-number">1.</span> <span class="toc-text">Concurrency Is Not Parallelism</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Concurrency"><span class="toc-number">1.1.</span> <span class="toc-text">Concurrency</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Parallelism"><span class="toc-number">1.2.</span> <span class="toc-text">Parallelism</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#VS"><span class="toc-number">1.3.</span> <span class="toc-text">VS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Go-Concurrency-Support"><span class="toc-number">1.4.</span> <span class="toc-text">Go Concurrency Support</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Go-Concurrency-Patterns"><span class="toc-number">2.</span> <span class="toc-text">Go Concurrency Patterns</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Service-Channel"><span class="toc-number">2.1.</span> <span class="toc-text">Service Channel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Multiplexing"><span class="toc-number">2.2.</span> <span class="toc-text">Multiplexing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sequencing"><span class="toc-number">2.3.</span> <span class="toc-text">Sequencing</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#for-select"><span class="toc-number">2.4.</span> <span class="toc-text">for-select</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#timeout-select"><span class="toc-number">2.5.</span> <span class="toc-text">timeout-select</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#quit-channel"><span class="toc-number">2.6.</span> <span class="toc-text">quit channel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Daisy-chain"><span class="toc-number">2.7.</span> <span class="toc-text">Daisy-chain</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Advanced-Go-Concurrency-Patterns"><span class="toc-number">3.</span> <span class="toc-text">Advanced Go Concurrency Patterns</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Three-techniques"><span class="toc-number">3.1.</span> <span class="toc-text">Three techniques</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#other-improvement"><span class="toc-number">3.2.</span> <span class="toc-text">other improvement</span></a></li></ol></li></ol></div><p>go的并发模式是一个很有意思的东西，这里先做个搬运工。<br>本文是go官方talk里对并发的定义及并发的模式的一些搜集</p><blockquote><p>原文引自：<br>Advanced Go Concurrency Patterns</p><ul><li><a href="https://www.youtube.com/watch?v=QDDwwePbDtw" target="_blank" rel="external">Youtube</a></li><li><a href="https://talks.golang.org/2013/advconc.slide#1" target="_blank" rel="external">slide</a></li><li><a href="https://github.com/golang/talks/tree/master/2013/advconc" target="_blank" rel="external">code</a></li></ul><p>Go Concurrency Patterns</p><ul><li><a href="https://www.youtube.com/watch?v=f6kdp27TYZs" target="_blank" rel="external">Youtube</a></li><li><a href="https://talks.golang.org/2012/concurrency.slide#1" target="_blank" rel="external">slide</a></li></ul><p>Concurrency Is Not Parallelism</p><ul><li><a href="https://www.youtube.com/watch?v=cN_DpYBzKso" target="_blank" rel="external">Youtube</a></li><li><a href="https://talks.golang.org/2012/waza.slide#1" target="_blank" rel="external">slide</a></li><li><a href="http://tonybai.com/2015/06/23/concurrency-and-parallelism/" target="_blank" rel="external">并发不是并行</a></li></ul></blockquote><a id="more"></a><h1 id="Concurrency-Is-Not-Parallelism"><a href="#Concurrency-Is-Not-Parallelism" class="headerlink" title="Concurrency Is Not Parallelism"></a>Concurrency Is Not Parallelism</h1><p>Concurrency (并发) 是程序能<strong>组织</strong>执行过程使同时可以处理多件事<br>Parallelism (并行) 是程序能同时<strong>执行</strong>多件事</p><p>所以Rob Pike说：并发关乎结构，并行关乎执行</p><h2 id="Concurrency"><a href="#Concurrency" class="headerlink" title="Concurrency"></a>Concurrency</h2><p>Concurrency is the composition of independently executing computations.</p><p>Concurrency is a way to structure software, particularly as a way to write clean code that interacts well with the real world.</p><p>Concurrency is about dealing with lots of things at once.</p><h2 id="Parallelism"><a href="#Parallelism" class="headerlink" title="Parallelism"></a>Parallelism</h2><p>Parallelism is the simultaneous execution of (possibly related) computations.</p><p>Parallelism is about doing lots of things at once.</p><h2 id="VS"><a href="#VS" class="headerlink" title="VS"></a>VS</h2><p>Concurrency is about structure, parallelism is about execution.</p><p>Concurrency provides a way to structure a solution to solve a problem that may (but not necessarily) be parallelizable.</p><h2 id="Go-Concurrency-Support"><a href="#Go-Concurrency-Support" class="headerlink" title="Go Concurrency Support"></a>Go Concurrency Support</h2><ul><li>concurrent execution (goroutines) 协程支持</li><li>synchronization and messaging (channels) CSP的通信方式来共享内存<br>此处需了解<a href="http://blog.newbmiao.com/2018/02/06/go-memory-model.html">go的内存模型</a></li><li>multi-way concurrent control (select) 控制协程切换<ul><li>All channels are evaluated.<br>每个通道都会被评估</li><li>Selection blocks until one communication can proceed, which then does.<br>没有可处理的通道时，select会一直阻塞</li><li>If multiple can proceed, select chooses pseudo-randomly.<br>多个通道可执行是，select会伪随机选一个</li><li>A default clause, if present, executes immediately if no channel is ready.<br>有default申明时，若没有可处理通道，则default立马执行</li></ul></li></ul><h1 id="Go-Concurrency-Patterns"><a href="#Go-Concurrency-Patterns" class="headerlink" title="Go Concurrency Patterns"></a>Go Concurrency Patterns</h1><h2 id="Service-Channel"><a href="#Service-Channel" class="headerlink" title="Service Channel"></a>Service Channel</h2><p>channel是go里<code>first class</code>值，想string这些类型一样。<br>用作函数返回时，通过返回的channel进行交互，可以起到服务一样的效果。</p><p><a href="https://play.golang.org/p/YLBW2G3SeFp" target="_blank" rel="external">运行</a><br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	joe := boring(<span class="string">"Joe"</span>)</div><div class="line">	ann := boring(<span class="string">"Ann"</span>)</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</div><div class="line">		fmt.Println(&lt;-joe)</div><div class="line">		fmt.Println(&lt;-ann)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(<span class="string">"You're both boring; I'm leaving."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">boring</span><span class="params">(msg <span class="keyword">string</span>)</span> &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123; <span class="comment">// Returns receive-only channel of strings.</span></div><div class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// We launch the goroutine from inside the function.</span></div><div class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">			c &lt;- fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i)</div><div class="line">			time.Sleep(time.Duration(rand.Intn(<span class="number">1e3</span>)) * time.Millisecond)</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line">	<span class="keyword">return</span> c <span class="comment">// Return the channel to the caller.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h2 id="Multiplexing"><a href="#Multiplexing" class="headerlink" title="Multiplexing"></a>Multiplexing</h2><p>就是将多个输入处理成一个，常见实现是使用go启动多个协程去合并；或者使用for-select去合并</p><p><a href="https://play.golang.org/p/G4gpS8-g36Y" target="_blank" rel="external">运行</a><br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	c := fanIn(boring(<span class="string">"Joe"</span>), boring(<span class="string">"Ann"</span>))</div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</div><div class="line">		fmt.Println(&lt;-c)</div><div class="line">	&#125;</div><div class="line">	fmt.Println(<span class="string">"You're both boring; I'm leaving."</span>)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1, input2 &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span> &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123;</div><div class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="keyword">for</span> &#123; c &lt;- &lt;-input1&#125; &#125;()</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="keyword">for</span> &#123; c &lt;- &lt;-input2&#125; &#125;()</div><div class="line">	<span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><blockquote><p>fan-in: A function can read from multiple inputs and proceed until all are closed by multiplexing the input channels onto a single channel that’s closed when all the inputs are closed.<br>fan-out: Multiple functions can read from the same channel until that channel is closed)<br><a href="https://blog.golang.org/pipelines" target="_blank" rel="external">pipeline</a></p></blockquote><h2 id="Sequencing"><a href="#Sequencing" class="headerlink" title="Sequencing"></a>Sequencing</h2><p>按顺序执行，用<strong>全局通道</strong>去发送接受来控制任务依次执行<br><a href="https://play.golang.org/p/VwVSQ_4I2ex" target="_blank" rel="external">运行</a></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Message <span class="keyword">struct</span> &#123;</div><div class="line">    str <span class="keyword">string</span></div><div class="line">    wait <span class="keyword">chan</span> <span class="keyword">bool</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//main</span></div><div class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</div><div class="line">    msg1 := &lt;-c; fmt.Println(msg1.str)</div><div class="line">    msg2 := &lt;-c; fmt.Println(msg2.str)</div><div class="line">    msg1.wait &lt;- <span class="literal">true</span></div><div class="line">    msg2.wait &lt;- <span class="literal">true</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//boring</span></div><div class="line">waitForIt := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">bool</span>) <span class="comment">// Give main control over our execution.</span></div><div class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; <span class="comment">// Launch the goroutine from inside the function. Function Literal.</span></div><div class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; ; i++ &#123;</div><div class="line">        c &lt;- Message&#123;fmt.Sprintf(<span class="string">"%s %d"</span>, msg, i), waitForIt&#125;</div><div class="line">        time.Sleep(time.Duration(rand.Intn(<span class="number">1e3</span>)) * time.Millisecond)</div><div class="line"></div><div class="line">        &lt;-waitForIt <span class="comment">// Block until main tells us to go again.</span></div><div class="line">	&#125;</div><div class="line">&#125;()</div></pre></td></tr></table></figure><h2 id="for-select"><a href="#for-select" class="headerlink" title="for-select"></a>for-select</h2><p>简化go创建多个协程的声明方式<br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">fanIn</span><span class="params">(input1, input2 &lt;-<span class="keyword">chan</span> <span class="keyword">string</span>)</span> &lt;-<span class="title">chan</span> <span class="title">string</span></span> &#123;</div><div class="line">    c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">        <span class="keyword">for</span> &#123;</div><div class="line">            <span class="keyword">select</span> &#123;</div><div class="line">            <span class="keyword">case</span> s := &lt;-input1:  c &lt;- s</div><div class="line">            <span class="keyword">case</span> s := &lt;-input2:  c &lt;- s</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;()</div><div class="line">    <span class="keyword">return</span> c</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h2 id="timeout-select"><a href="#timeout-select" class="headerlink" title="timeout-select"></a>timeout-select</h2><p>对select可以增加超时通道，超时则返回，避免select一直阻塞<br></p><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">func</span> <span class="selector-tag">main</span>() &#123;</div><div class="line">    <span class="attribute">c </span>:= <span class="built_in">boring</span>(<span class="string">"Joe"</span>)</div><div class="line">    for &#123;</div><div class="line">        select &#123;</div><div class="line">        case s := &lt;-c:</div><div class="line">            fmt.<span class="built_in">Println</span>(s)</div><div class="line">        case &lt;-time.<span class="built_in">After</span>(1 * time.Second):</div><div class="line">            fmt.<span class="built_in">Println</span>(<span class="string">"You're too slow."</span>)</div><div class="line">            return</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h2 id="quit-channel"><a href="#quit-channel" class="headerlink" title="quit channel"></a>quit channel</h2><p>使用通道控制执行是否提前结束</p><ul><li><p>just quit</p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//main</span></div><div class="line">quit := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</div><div class="line">c := boring(<span class="string">"Joe"</span>, quit)</div><div class="line"><span class="keyword">for</span> i := rand.Intn(<span class="number">10</span>); i &gt;= <span class="number">0</span>; i-- &#123; fmt.Println(&lt;-c) &#125;</div><div class="line">quit &lt;- <span class="keyword">struct</span>&#123;&#125;</div><div class="line"></div><div class="line">	<span class="keyword">select</span> &#123;</div><div class="line">	<span class="keyword">case</span> c &lt;- fmt.Sprintf(<span class="string">"%s: %d"</span>, msg, i):</div><div class="line">		<span class="comment">// do nothing</span></div><div class="line">	<span class="keyword">case</span> &lt;-quit:</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div></pre></td></tr></table></figure></li><li><p>use quit deliver msg<br><code>quit := make(chan string)</code></p></li></ul><h2 id="Daisy-chain"><a href="#Daisy-chain" class="headerlink" title="Daisy-chain"></a>Daisy-chain</h2><p>关于这个模式stackoverflow有个<a href="https://stackoverflow.com/questions/26135616/understand-the-code-go-concurrency-pattern-daisy-chain" target="_blank" rel="external">讨论</a>，可以看看<br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(left, right <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    left &lt;- <span class="number">1</span> + &lt;-right</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    <span class="keyword">const</span> n = <span class="number">10000</span></div><div class="line">    leftmost := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">    right := leftmost</div><div class="line">    left := leftmost</div><div class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</div><div class="line">        right = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</div><div class="line">        <span class="keyword">go</span> f(left, right)</div><div class="line">        left = right</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(c <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span> &#123; c &lt;- <span class="number">1</span> &#125;(right)</div><div class="line">    fmt.Println(&lt;-leftmost)</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><h1 id="Advanced-Go-Concurrency-Patterns"><a href="#Advanced-Go-Concurrency-Patterns" class="headerlink" title="Advanced Go Concurrency Patterns"></a>Advanced Go Concurrency Patterns</h1><h2 id="Three-techniques"><a href="#Three-techniques" class="headerlink" title="Three techniques"></a>Three techniques</h2><ul><li>for-select loop<br>select防止loop阻塞在某一状态，便于调度多项任务</li><li><p>service channel, reply channels (chan chan error)<br>service channel就是常见的pattern，不多说<br>reply channels实现了close操作中关闭和错误返回无<code>data race</code>:<br><strong>close通过<code>chan chan error</code>向loop请求关闭，并等待其返回关闭前是否有错误</strong></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *sub)</span> <span class="title">Close</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	errc := <span class="built_in">make</span>(<span class="keyword">chan</span> error)</div><div class="line">	s.closing &lt;- errc <span class="comment">// HLchan  //请求关闭</span></div><div class="line">	<span class="keyword">return</span> &lt;-errc     <span class="comment">// HLchan  //等待结果返回</span></div><div class="line">&#125;</div><div class="line"><span class="comment">//in loop</span></div><div class="line"><span class="keyword">var</span> err error</div><div class="line"><span class="keyword">for</span>&#123;</div><div class="line">    <span class="keyword">select</span>&#123;</div><div class="line">        <span class="keyword">case</span> errc := &lt;-s.closing: <span class="comment">//收到关闭请求</span></div><div class="line">            errc &lt;- err           <span class="comment">//返回错误</span></div><div class="line">            <span class="built_in">close</span>(s.updates)      <span class="comment">//执行关闭</span></div><div class="line">            <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></li><li><p>nil channels in select cases<br>向值为nil的channel发送和接收都会阻塞，在select中使用它可控制是否执行</p></li></ul><p>此外，分享中提到一些点也值得注意：</p><h2 id="other-improvement"><a href="#other-improvement" class="headerlink" title="other improvement"></a>other improvement</h2><ul><li>limit：限制pending（处理任务队列）的数目，不要让其无限增大，避免过多请求及内存消耗</li><li>async io：拆解fetch的请求和结果处理，使用状态channel同步，使fetch中不要阻塞其他处理进行<br><strong>拆解前</strong><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> &lt;-startFetch:</div><div class="line">    var fetched []Item</div><div class="line">    fetched, <span class="keyword">next</span>, <span class="built_in">err</span> = s.fetcher.Fetch()</div><div class="line">    <span class="keyword">if</span> <span class="built_in">err</span> != nil &#123;</div><div class="line">        <span class="keyword">next</span> = <span class="built_in">time</span>.<span class="built_in">Now</span>().Add(<span class="number">10</span> * <span class="built_in">time</span>.<span class="built_in">Second</span>)</div><div class="line">        break</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> _, item := range fetched &#123;</div><div class="line">        <span class="keyword">if</span> !seen[item.GUID] &#123;</div><div class="line">            pending = append(pending, item)</div><div class="line">            seen[item.GUID] = <span class="literal">true</span>         </div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></li></ul><p><strong>拆解后</strong><br>startFetch和fetchDone同一时刻，只有一个不为<code>nil</code><br></p><figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> fetchResult <span class="keyword">struct</span>&#123; fetched []Item; next time.Time; err error &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> fetchDone <span class="keyword">chan</span> fetchResult <span class="comment">// if non-nil, Fetch is running</span></div><div class="line"></div><div class="line">        <span class="keyword">var</span> startFetch &lt;-<span class="keyword">chan</span> time.Time</div><div class="line">        <span class="keyword">if</span> fetchDone == <span class="literal">nil</span> &amp;&amp; <span class="built_in">len</span>(pending) &lt; maxPending &#123;</div><div class="line">            startFetch = time.After(fetchDelay) <span class="comment">// enable fetch case</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">select</span> &#123;</div><div class="line">        <span class="keyword">case</span> &lt;-startFetch:</div><div class="line">            fetchDone = <span class="built_in">make</span>(<span class="keyword">chan</span> fetchResult, <span class="number">1</span>)</div><div class="line">            <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">                fetched, next, err := s.fetcher.Fetch()</div><div class="line">                fetchDone &lt;- fetchResult&#123;fetched, next, err&#125;</div><div class="line">            &#125;()</div><div class="line">        <span class="keyword">case</span> result := &lt;-fetchDone: </div><div class="line">            fetchDone = <span class="literal">nil</span></div><div class="line">            <span class="comment">// Use result.fetched, result.next, result.err</span></div></pre></td></tr></table></figure><p></p><p>这是对以上模式整合实现的一个rss聚合器demo，可以仔细研究下<br><a href="https://play.golang.org/p/j_npc1o3zZp" target="_blank" rel="external">运行</a></p><blockquote style="padding:10px;background:#efe none repeat scroll 0 0;border-left-color:green">如有疑问，请留言或邮件<a href="mailto:newbvirgil@gmail.com" title="newbvirgil@gmail.com">newbvirgil@gmail.com</a><br>本文链接 : <a href="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html" title="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html" target="_blank" rel="external">http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html</a></blockquote></div><footer class="article-footer"><a data-url="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html" data-id="cjmvnk5uv00019u31jujwqkk6" class="article-share-link" data-share="baidu">分享到</a> <a href="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html#disqus_thread" class="article-comment-link">评论</a><ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/concurrency/">concurrency</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/">go</a></li></ul><span id="busuanzi_container_page_pv" style="color:#999"><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span>次阅读 </span><span style="color:#999">&nbsp; | &nbsp;最近更新 ：<time datetime="2018-10-05T06:49:08.832Z" itemprop="dateModify">2018-10-05</time></span></footer></div></article><section id="comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></section></section><aside id="sidebar"><div class="widget-wrap"><h3 class="widget-title">近期文章</h3><div class="widget"><ul><li><a href="/2018/08/20/go-source-analysis-of-memory-alloc.html">go源码分析之内存分配</a></li><li><a href="/2018/03/15/go-value-layout-in-memory.html">go学习之类型的数据结构内存分布</a></li><li><a href="/2018/03/05/go-value-in-heap-and-stack.html">go学习之堆栈中的变量</a></li><li><a href="/2018/02/09/advanced-go-concurrency-patterns.html">Advanced Go Concurrency Patterns</a></li><li><a href="/2018/02/06/go-memory-model.html">Go Memory Model</a></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">分类</h3><div class="widget"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/">blog</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/blog/dropbox/">dropbox</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/blog/hexo/">hexo</a><span class="category-list-count">3</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/gearman/">gearman</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/go/">go</a><span class="category-list-count">5</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/go/notes/">notes</a><span class="category-list-count">5</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/html5/">html5</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/journal/">journal</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/js/">js</a><span class="category-list-count">6</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/js/jquery/">jquery</a><span class="category-list-count">4</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">7</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/notes/">notes</a><span class="category-list-count">7</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/">mac</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mac/shadowsocks/">shadowsocks</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mac/tool/">tool</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">4</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/optimize/">optimize</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/">php</a><span class="category-list-count">13</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/php/CI/">CI</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/regex/">regex</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/signal/">signal</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/php/tool/">tool</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/redis/">redis</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/">web</a><span class="category-list-count">8</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/web/notes/">notes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/web/practice/">practice</a><span class="category-list-count">4</span></li></ul></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">标签云</h3><div class="widget tagcloud"><a href="/tags/target/" style="font-size:15px;color:#1e90ff">target</a> <a href="/tags/hexo/" style="font-size:18.33px;color:#2c93ea">hexo</a> <a href="/tags/gitcafe/" style="font-size:15px;color:#1e90ff">gitcafe</a> <a href="/tags/gearman/" style="font-size:15px;color:#1e90ff">gearman</a> <a href="/tags/journal/" style="font-size:16.67px;color:#2592f4">journal</a> <a href="/tags/html5/" style="font-size:16.67px;color:#2592f4">html5</a> <a href="/tags/js/" style="font-size:30px;color:#5f9ea0">js</a> <a href="/tags/drag/" style="font-size:16.67px;color:#2592f4">drag</a> <a href="/tags/chrome/" style="font-size:15px;color:#1e90ff">chrome</a> <a href="/tags/javascript-program-solution/" style="font-size:18.33px;color:#2c93ea">javascript-program-solution</a> <a href="/tags/maintainable-javascript/" style="font-size:15px;color:#1e90ff">maintainable-javascript</a> <a href="/tags/random/" style="font-size:15px;color:#1e90ff">random</a> <a href="/tags/git/" style="font-size:15px;color:#1e90ff">git</a> <a href="/tags/linux/" style="font-size:26.67px;color:#519bb5">linux</a> <a href="/tags/mac/" style="font-size:18.33px;color:#2c93ea">mac</a> <a href="/tags/vim/" style="font-size:15px;color:#1e90ff">vim</a> <a href="/tags/tool/" style="font-size:15px;color:#1e90ff">tool</a> <a href="/tags/shadowsocks/" style="font-size:15px;color:#1e90ff">shadowsocks</a> <a href="/tags/software/" style="font-size:15px;color:#1e90ff">software</a> <a href="/tags/mysql/" style="font-size:20px;color:#3495df">mysql</a> <a href="/tags/limit/" style="font-size:15px;color:#1e90ff">limit</a> <a href="/tags/imgick/" style="font-size:15px;color:#1e90ff">imgick</a> <a href="/tags/json/" style="font-size:15px;color:#1e90ff">json</a> <a href="/tags/blob/" style="font-size:15px;color:#1e90ff">blob</a> <a href="/tags/php/" style="font-size:28.33px;color:#589cab">php</a> <a href="/tags/reference/" style="font-size:15px;color:#1e90ff">reference</a> <a href="/tags/blog/" style="font-size:20px;color:#3495df">blog</a> <a href="/tags/phpdoc/" style="font-size:15px;color:#1e90ff">phpdoc</a> <a href="/tags/function/" style="font-size:15px;color:#1e90ff">function</a> <a href="/tags/php-fpm/" style="font-size:15px;color:#1e90ff">php-fpm</a> <a href="/tags/apache/" style="font-size:15px;color:#1e90ff">apache</a> <a href="/tags/redis/" style="font-size:15px;color:#1e90ff">redis</a> <a href="/tags/regex/" style="font-size:15px;color:#1e90ff">regex</a> <a href="/tags/jquery/" style="font-size:21.67px;color:#3b96d5">jquery</a> <a href="/tags/iframe/" style="font-size:15px;color:#1e90ff">iframe</a> <a href="/tags/dropbox/" style="font-size:15px;color:#1e90ff">dropbox</a> <a href="/tags/closure/" style="font-size:15px;color:#1e90ff">closure</a> <a href="/tags/cors/" style="font-size:15px;color:#1e90ff">cors</a> <a href="/tags/go/" style="font-size:23.33px;color:#4298ca">go</a> <a href="/tags/jquery-timepicker-addon/" style="font-size:15px;color:#1e90ff">jquery-timepicker-addon</a> <a href="/tags/ajax/" style="font-size:15px;color:#1e90ff">ajax</a> <a href="/tags/promise/" style="font-size:15px;color:#1e90ff">promise</a> <a href="/tags/notes/" style="font-size:25px;color:#4999c0">notes</a> <a href="/tags/CI/" style="font-size:15px;color:#1e90ff">CI</a> <a href="/tags/pcntl/" style="font-size:15px;color:#1e90ff">pcntl</a> <a href="/tags/signal/" style="font-size:15px;color:#1e90ff">signal</a> <a href="/tags/laradock/" style="font-size:15px;color:#1e90ff">laradock</a> <a href="/tags/docker/" style="font-size:15px;color:#1e90ff">docker</a> <a href="/tags/xdebug/" style="font-size:15px;color:#1e90ff">xdebug</a> <a href="/tags/concurrency/" style="font-size:15px;color:#1e90ff">concurrency</a> <a href="/tags/happens-before/" style="font-size:15px;color:#1e90ff">happens-before</a> <a href="/tags/slice/" style="font-size:15px;color:#1e90ff">slice</a> <a href="/tags/panic/" style="font-size:15px;color:#1e90ff">panic</a></div></div><div class="widget-wrap"><h3 class="widget-title">归档</h3><div class="widget"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">五月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">三月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">九月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">九月 2015</a><span class="archive-list-count">15</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">八月 2015</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">七月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">六月 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">三月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">二月 2015</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">一月 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">十二月 2014</a><span class="archive-list-count">1</span></li></ul></div></div><div class="widget-wrap"><h3 class="widget-title">友情链接</h3><div class="widget"><ul><li><a href="http://coolshell.cn/" target="_blank">酷壳</a></li><li><a href="http://leo108.com/" target="_blank">leo108</a></li><li><a href="http://www.cnblogs.com/liaoziyu/" target="_blank">大粨兔奶糖</a></li><li><a href="http://blog.ihuxu.com/" target="_blank">胡小旭</a></li><li><a href="http://bin.bloggao.cn/" target="_blank">liecol-晓斌</a></li><li><a href="http://xianfengsong.github.io/" target="_blank">先锋Song</a></li></ul></div></div><div class="widget-wrap widget-toc" style="display:none"><h3 class="widget-title">文章目录</h3><div class="container widget" style="padding:15px 20px"></div></div><script src="//media.newbmiao.com/blog/asset/js/toc.js"></script></aside></div><footer id="footer"><script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><div class="outer"><div id="footer-info" class="inner">&copy; 2018 菜鸟Miao<br><p><span id="busuanzi_container_site_uv">您是本站第<span id="busuanzi_value_site_uv"> <i class="fa fa-spinner fa-spin"></i></span>个访问者 </span><span id="busuanzi_container_site_pv">/本站总访问量<span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i> </span>次</span></p>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> . Theme by <a href="https://github.com/xiangming/landscape-plus" target="_blank">Landscape-plus</a> . Hosted by <a href="https://pages.coding.me" style="font-weight:700" target="_blank">Coding Pages</a> &amp; <a href="https://github.com/newbmiao" target="_blank" style="font-weight:700">GitHub Pages</a> .</div></div></footer></div><nav id="mobile-nav"><a href="/" class="mobile-nav-link">Home</a> <a href="/archives" class="mobile-nav-link">Archives</a> <a href="/add-ons" class="mobile-nav-link">Add-ons</a> <a href="/invest" class="mobile-nav-link">Invest</a></nav><script src="http://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script><div id="totop"><a title="返回顶部"><img src="/img/scrollup.png"></a></div><script>var disqus_shortname="newbmiao",disqus_url="http://blog.newbmiao.com/2018/02/09/advanced-go-concurrency-patterns.html";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><div id="article-share-box" class="article-share-box"><div id="bdshare" class="bdsharebuttonbox article-share-links"><a class="article-share-weibo" data-cmd="tsina" title="分享到新浪微博"></a> <a class="article-share-weixin" data-cmd="weixin" title="分享到微信"></a> <a class="article-share-qq" data-cmd="sqq" title="分享到QQ"></a> <a class="article-share-renren" data-cmd="renren" title="分享到人人网"></a> <a class="article-share-more" data-cmd="more" title="更多"></a></div></div><script>with(window._bd_share_config={common:{},share:{bdCustomStyle:"/css/bdshare.css"}},document)(0)[(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion="+~(-new Date/36e5)]</script><link rel="stylesheet" href="//media.newbmiao.com/blog/asset/fancybox/jquery.fancybox.css" media="screen" type="text/css"><script src="//media.newbmiao.com/blog/asset/fancybox/jquery.fancybox.pack.js"></script><script src="//media.newbmiao.com/blog/asset/js/script.js"></script><script type="text/javascript">!function(t,e,n,s,c,i,o){t.SwiftypeObject=c,t[c]=t[c]||function(){(t[c].q=t[c].q||[]).push(arguments)},i=e.createElement(n),o=e.getElementsByTagName(n)[0],i.async=1,i.src=s,o.parentNode.insertBefore(i,o)}(window,document,"script","//s.swiftypecdn.com/install/v2/st.js","_st"),_st("install","bqAniPPC1T7RV4MomxcE","2.0.0")</script></div></body><!-- rebuild by neat -->